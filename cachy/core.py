"""Cache your API calls with a single line of code. No mocks, no fixtures. Just faster, cleaner code."""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/00_core.ipynb.

# %% auto #0
__all__ = ['doms', 'enable_cachy', 'disable_cachy']

# %% ../nbs/00_core.ipynb #fa68c98b
import hashlib,httpx,json
from fastcore.utils import *

# %% ../nbs/00_core.ipynb #527e76df
doms = ("api.openai.com", "api.anthropic.com", "generativelanguage.googleapis.com", "api.deepseek.com")

# %% ../nbs/00_core.ipynb #09571365
def _should_cache(url, doms): return any(dom in str(url) for dom in doms)

# %% ../nbs/00_core.ipynb #6924d508
def _cache(key, cfp):
    with open(cfp, "r") as f:
        line = first(f, lambda l: json.loads(l)["key"] == key)
        return json.loads(line) if line else None

# %% ../nbs/00_core.ipynb #72a0213b
def _write_cache(key, content, cfp, hdrs):
    with open(cfp, "a") as f: f.write(json.dumps({"key":key, "response": content, "headers":hdrs})+"\n")

# %% ../nbs/00_core.ipynb #3c7fca19
def _content(r):
    "Extract content from request."
    if not hasattr(r, '_content'): r.read()
    boundary = httpx._multipart.get_multipart_boundary_from_content_type(r.headers.get("Content-Type", "").encode())
    return r.content.replace(boundary, b"cachy-boundary") if boundary else r.content

# %% ../nbs/00_core.ipynb #a69ba22c
def _key(r, is_stream=False):
    "Create a unique, deterministic id from the request `r`."
    return hashlib.sha256(f"{r.url.copy_remove_param('key')}{is_stream}".encode() + _content(r)).hexdigest()[:8]

# %% ../nbs/00_core.ipynb #25ced1ba
def _res_hdrs(res, hdrs=None): return {k: v for k, v in res.headers.items() if k.lower() in hdrs} if hdrs else None

# %% ../nbs/00_core.ipynb #78203d16
def _apply_async_patch(cfp, doms, hdrs):    
    @patch
    async def send(self:httpx._client.AsyncClient, r, **kwargs):
        is_stream = kwargs.get("stream")
        if not _should_cache(r.url, doms): return await self._orig_send(r, **kwargs)
        key = _key(r, is_stream=False)
        if res := _cache(key,cfp): return httpx.Response(status_code=200, content=res['response'], headers=res.get('headers'), request=r)
        res = await self._orig_send(r, **kwargs)
        content = res.read().decode() if not is_stream else b''.join([c async for c in res.aiter_bytes()]).decode()
        headers = _res_hdrs(res, hdrs)
        _write_cache(key,content,cfp,headers)
        return httpx.Response(status_code=res.status_code, content=content, headers=headers, request=r)

# %% ../nbs/00_core.ipynb #92ee9a9e
def _apply_sync_patch(cfp, doms, hdrs):    
    @patch
    def send(self:httpx._client.Client, r, **kwargs):
        is_stream = kwargs.get("stream")
        if not _should_cache(r.url, doms): return self._orig_send(r, **kwargs)
        key = _key(r, is_stream=False)
        if res := _cache(key,cfp): return httpx.Response(status_code=200, content=res['response'], headers=res.get('headers'), request=r)
        res = self._orig_send(r, **kwargs)
        content = res.read().decode() if not is_stream else b''.join(list(res.iter_bytes())).decode()
        headers = _res_hdrs(res, hdrs)
        _write_cache(key,content,cfp,headers)
        return httpx.Response(status_code=res.status_code, content=content, headers=headers, request=r)

# %% ../nbs/00_core.ipynb #f05ad1d1
def enable_cachy(cache_dir=None, doms=doms, hdrs=None):
    if hdrs is None: hdrs=[]
    cfp = Path(cache_dir or find_file_parents("pyproject.toml") or ".") / "cachy.jsonl"
    cfp.touch(exist_ok=True)   
    _apply_sync_patch(cfp, doms, hdrs)
    _apply_async_patch(cfp, doms, hdrs)

# %% ../nbs/00_core.ipynb #2c960325
def disable_cachy():
    httpx._client.AsyncClient.send = httpx._client.AsyncClient._orig_send
    httpx._client.Client.send      = httpx._client.Client._orig_send
